{% extends "socialgraph/base.html" %}

{% block content %}

    <div class="container">
      <div class="row">
        <div class="col-md-4">
            <h3 class="content-section-title">Users</h3>
            <div class="content-section" id="usersContentSection">

                <ul class="list-group">

                {% for node in nodes %}

                    <li class="list-group-item">{{ node.name }}</li>

                {% endfor %}

                </ul>

            </div>
        </div>
        <div class="col-md-8">
            <h3 class="content-section-title">Graph</h3>
          <div class="content-section" id="graphContentSection">

              <div id="my_dataviz"></div>

          </div>
        </div>
      </div>
    </div>

    <script>

        // Define node size and marker size and position
        var nodeRadius = 15;
        var markerSize = 10;
        var markerX = nodeRadius + markerSize;

        // set the dimensions and margins of the graph
        var margin = {top: 30, right: 30, bottom: 30, left: 30},
          width = 800 - margin.left - margin.right,
          height = 1000 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + 5 + "," + 5 + ")");


        svg.append("svg:defs").selectAll("marker")
            .data(["end"])      // Different link/path types can be defined here
          .enter().append("svg:marker")    // This section adds in the arrows
            .attr("id", String)
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", markerX)
            .attr("refY", 0.5)
            .attr("markerWidth", markerSize)
            .attr("markerHeight", markerSize)
            .attr("orient", "auto")
          .append("svg:path")
            .attr("d", "M0,-5L10,0L0,5");

        d3.json( "/static/socialgraph/testData.json", function(data) {

          // Initialize the links
          var link = svg
            .selectAll("line")
            .data(data.links)
            .enter()
            .append("line")
              .style("stroke", "#aaa")
            .attr("marker-end", "url(#end)")

          // Initialize the nodes
          var node = svg
            .selectAll("circle")
            .data(data.nodes)
            .enter()
            .append("circle")
              .attr("r", nodeRadius)
              .style("fill", "#69b3a2")
              .attr('id', function(d){ return 'id' + d.id })

          // Let's list the force we wanna apply on the network
          var simulation = d3.forceSimulation(data.nodes)                 // Force algorithm is applied to data.nodes
              .force("link", d3.forceLink()                               // This force provides links between nodes
                    .id(function(d) { return d.id; })                     // This provide  the id of a node
                    .links(data.links)                                    // and this the list of links
              )
              .force("charge", d3.forceManyBody().strength(-1000))         // This adds repulsion between nodes. Play with the -400 for the repulsion strength
              .force("center", d3.forceCenter(width / 2, height / 2))     // This force attracts nodes to the center of the svg area
              .on("end", ticked);

          // This function is run at each iteration of the force algorithm, updating the nodes position.
          function ticked() {
            link
                .attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node
                 .attr("cx", function (d) { return d.x; })
                 .attr("cy", function(d) { return d.y; });
          }

        });




        $(".list-group-item").click(function() {

            // Select all list items
            var listItems = $(".list-group-item");

            // Remove 'active' tag for all list items
            for (let i = 0; i < listItems.length; i++) {
                listItems[i].classList.remove("active");
            }

            // Add 'active' tag for currently selected item
            this.classList.add("active");

            var selectedNode = $(this).text();

            {% for node in nodes %}

                var currentNode = "{{ node.name }}";
                var c = d3.select("#id" + {{ node.id }});
                    c.style("fill", "#69b3a2");

                if (selectedNode === currentNode) {
                    console.log(selectedNode + " : " + {{ node.id }});

                    var circle = d3.select("#id" + {{ node.id }});
                    circle.style("fill", "red");

                }

            {% endfor %}

        });


    </script>


{% endblock content %}