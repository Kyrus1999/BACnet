# EventCreationTool

This is a simple tool for creating BACnet feeds and events.
Current version is 1.1

## Content

* [Requirements and installation](#requirements-and-installation)
* [Supported signing and hashing algorithms](#supported-signing-and-hashing-algorithms)
* [Quick start guide](#quick-start-guide)
  - [Additional important information](#additional-important-information)
* [Full API specification](#full-api-specification)
  - [Private key file format](#private-key-file-format)
  - [exception HashingAlgorithmNotFoundException](#exception-hashingalgorithmnotfoundexception)
  - [exception SigningAlgorithmNotFoundException](#exception-signingalgorithmnotfoundexception)
  - [exception KeyFileNotFoundException](#exception-keyfilenotfoundexception)
  - [exception IllegalArgumentTypeException](#exception-illegalargumenttypeexception)
  - [class EventFactory](#class-eventfactory)
  - [class EventCreationTool](#class-eventcreationtool)
* [Changelog](#changelog)

## Requirements and installation
In order to use the tool, you have to install the following python packages:
* PyNaCl
* cbor2

We recommend to install them using pip:
```
> pip install cbor2
> pip install pynacl
```

The tool provides the two python classes `PythonCreationTool` and `EventFactory` which you can use as API. 
To use the tool you need the two  python files `PythonCreationTool.py` and `Event.py`. Copy them over to your 
project (you could drop them in a separate folder) in order to use the tool.

We are thinking about creating a `pip install` package, but are currently busy.

## Supported signing and hashing algorithms
Currently we support the following signing algorithms:
* ED25519
* HMAC_SHA256

And the following hashing algorithms:
* SHA256

Feel free to contact us if you need different ones!

## Quick start guide 
Once you installed the tool, you probably want to start off by creating a new feed. The simplest way to do so is by 
creating a new object of the class `EventFactory`:
```python
import EventCreationTool
ecf = EventCreationTool.EventFactory()
```
This will create a new feed. If you want to create multiple feeds, you can simply create multiple `EventFactory` 
objects. You can now create events on that feed by using the `next_event()` method  and 
passing your custom content as follows:
```python
new_event = ecf.next_event(content_identifier, content_parameter)
```
When using this, please stick to the conventions for BACnet 
([here at the bottom](https://github.com/cn-uofbasel/BACnet/blob/master/doc/BACnet-event-structure.md)). 
Thus `content_identifier` should be a string like `'yourapp/yourcommand'` and `content_parameter` could 
be whatever you want (but using dictionaries is probably most convenient). 
Our tool does not, however, enforce the convention. 

If you restart your application and need the factory for the same feed again, you can simply obtain the last event 
from your database and pass that event when creating the factory object like this:
```python
last_event =  # Obtain the last event of the feed you want to append to from the database
ecf = EventCreationTool.EventFactory(last_event)
```
Make sure that the event you pass is really the most recent one. Otherwise the event chain of your feed will diversify.

#### Additional important information

The call `EventCreationTool.EventFactory()` will automatically create a `.key` file in your current working 
directory (i.e. the directory from which you ran the program that called the EventCreationTool). You can also 
specify another location to store your keys, as specified in the full API specification.

These files contain the private keys to your feeds. MAKE SURE TO NOT LOOSE THEM! If you loose these files, you will 
not be able to create new events (and our tool will throw some custom exceptions as specified 
[below](#full-api-specification))

The tools provides even more functionality as specified in the next section. There you will learn how to set custom 
private key paths, obtain private keys (you need them if you use hmac signing) or even set different signing 
and hashing algorithms.
Also, if you need a tool that allows more control, you could use the `EventCreationTool` class instead of 
`EventFactory`. API is specified below.

## Full API specification
#### Private key file format
Whenever a feed is created, a private key is generated. This key is binary saved in a file.
The naming convention we use is: `feed_id.key` (please note that the feed id and public key is the same thing.)
The file will be generated by default in the current working directory but the path can be adjusted as specified below.

#### exception HashingAlgorithmNotFoundException
This exception is thrown whenever you try to use a hashing algorithm that is not known to your used version of the tool.

#### exception SigningAlgorithmNotFoundException
This exception is thrown whenever you try to use a signing algorithm that is not known to your used version of the tool.

#### exception KeyFileNotFoundException
This exception is thrown whenever the tool needs access to a private key but this key is not available at the provided 
path. (For example thrown if you try to append to a feed that is not yours and you thus have not the private key.)

#### exception IllegalArgumentTypeException
This exception is thrown when you pass an argument which is of the wrong type. The exception message sometimes provides 
a list of accepted types, but you do best if you stick to the API below.

#### class EventFactory
The class EventFactory is the recommended API of this tool.

```python
__init__(last_event=None, path_to_keys=None, path_to_keys_relative=True,
             signing_algorithm='ed25519', hashing_algorithm='sha256')
```
* Returns: A new object of the class.
* Throws: `SigningAlgorithmNotFoundException`, `HashingAlgorithmNotFoundException`
* Parameters:
  - optional `last_event`: Type: `bytes` (cbor encoded as you can get it from the database).
  Event on which base the object is created. Sets up the created factory to yield following events. If this is not 
  specified, a new feed will be created.
  - optional `path_to_keys`: Type: `str`. If you need a specific path to private keys. Can be a relative or absolute 
  path (See following parameter). Default is the current working directory.
  - optional `path_to_keys_relative`: Type: `bool`. Must be set to `False` if the above specified path was an absolute 
  path.
  - optional `signing_algorithm`: Type: `str`. The signing algorithm you want to use. Refer to 
  [here](#supported-signing-and-hashing-algorithms) for supported algorithms.
  - optional `hashing_algorithm`: Type: `str`. The hashing algorithm you want to use.
* NOTE: `signing_algorithm` and `hashing_algorithm` will be ignored if you specify a `last_event`. In this case, the 
algorithms will be chosen to match the previous events of the feed. This is to protect you from misusing a feed.

```python
get_feed_id()
```
* Returns: Type: `bytes`. The feed id (i.e. the public key) of the associated feed.

```python
get_private_key()
```
* Returns: Type: `bytes`. The private key of the associated feed. If you need to obtain the key for a partner when using 
the `hmac` signing algorithms.
* Throws: `KeyFileNotFoundException`

```python
next_event(content_identifier, content_parameter=None):
```
* Returns: Type: `bytes` (cbor encoded). The new event that is generated together with your content. 
* Throws: `KeyFileNotFoundException` (If you try to append to a feed and do not have the private key at the specified 
location)
* Parameters:
  - `content_identifier`: Type: `str`. The identifier of the content you append. Please stick to the conventions 
  [here at the bottom](https://github.com/cn-uofbasel/BACnet/blob/master/doc/BACnet-event-structure.md). Looks 
  somehow like this: `appname/command`
  - optional `content_parameter`: Type: whatever. The content you want to save. Could be whatever but dictionary is 
  probably most convenient. A event without this parameter(s) is also valid. Also look 
  [here at the bottom](https://github.com/cn-uofbasel/BACnet/blob/master/doc/BACnet-event-structure.md)

#### class EventCreationTool
work on readme still in progress...

If you need some more control, you can use this class instead of `EventFactory`.
Using this class you do not need a separate object for each feed. It is however recommended to use separate objects 
for different hashing and signing algorithms (so you don't have to set the algorithm each time).

## Changelog
* V1.0: First release for extern use. API as specified [above](#full-api-specification).
* V1.1: Added EventFactory class for even simpler creation of events. Also some bugfixes and renaming.